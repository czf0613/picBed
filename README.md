# picBed

A cheap self-made pic bed, including user interfaces and a small script which can help software like Typora to upload images automatically.

如果不出意外的话，这篇readme文档里面的图片服务，就是我自己提供的啦！

首先来说一下开发这个软件的初衷吧。本质上来说，就是一个图床的功能。何为图床呢？不知大家有没有遇到过这样一个问题，在编写markdown文件的时候，我们并不能直接把图片的二进制文件插入，我们需要引用一个文件地址，然后再由markdown的编辑器自动将这个图片显示出来。这时我们难免遇到一个问题，如果我们需要把markdown文件拷给别人或者发布到GitHub上去的时候，这些图片都会失效，或者……你不得不把图片和markdown文件放到一起去然后用相对地址来引用它，这当然是相当不方便的。

当然，图床这个概念早就诞生了，但早期一直是由一些外国公司运营的，比如说SM.MS之类的服务，或者还有一个比较流行的叫做picGo的图床配置工具，但是……这些服务都不便宜（因为要用到对象存储服务），而且因为那些服务器都在国外，国内使用起来很慢。所以，咱们干脆自己动手，丰衣足食吧。我们就以SM.MS为模板，来造一个图片服务器吧。

[TOC]



## 1，技术路线

当然，这一回肯定还是用Springboot开发比较稳定，毕竟业内成熟的技术，要处理起来还是比较容易的，至少……坑可以少踩一点（其实坑一点也没少踩……咳咳咳）不过，当大家看到GitHub显示的代码语言组成占比的时候，应该已经发现有点不对劲了吧，是的你没看错，这是一个纯Kotlin开发的项目。

用纯Kotlin来开发Springboot项目，确实是疯掉了，而且……基本上可能很多东西还是在网上都找不到解决方案的，但u1s1，用Kotlin开发服务端项目的时候，似乎远没有在安卓端那么香，至少我是这么觉得的。

为什么这么说呢，首先就是可怜的生态问题，服务端项目绝大多数都是用Java构建的，然而Kotlin和Java的互操作性其实根本达不到100%，所以其实，我们会被各种各样的臭bug困扰。

再者就是，Kotlin最牛逼的两个功能：协程和空安全，在Springboot里面没有发挥的余地。首先就是，web项目最终的承载者是一个容器，比如说Tomcat或者Undertow之类的，那么，这个时候，协程的上下文就变成了一个很玄学的问题，所以，协程的发起就不得不使用GlobalScope.launch来处理，然而，这个东西所导致的泄漏问题和输出流意外关闭的问题，就非常尴尬了。再者，因为Java对象并不区分nullable和not null的问题，除非用装饰器来标记一下，然而……很多Spring源代码里面就没有考虑这个问题，这个就导致我们有的时候用Kotlin中的Obj，或者Obj?起不到空安全的作用，所以……空安全这个作用也没了。

最后的一个问题就是……编译是真滴慢啊，Kotlin的编译确实要比Java慢不少啊，这个项目也就几千行代码，编译就要7-8秒。

所以，一言以蔽之，这回用Kotlin写服务端确实是一次疯狂的尝试，算是长长见识了，不过，我还是更建议用Kotlin和Java的混合项目会更好。



## 2，前期准备

首先你需要一台有比较大硬盘空间的服务器，如果没有服务器的话也不要紧，用花生壳给自己的电脑动态分配一个域名或者公网IP就够了，然后就可以利用自己的电脑搭建这个服务。

接着就是一个数据库，数据库要尽可能保证安全，因为上传后文件的地址就存放在数据库里（请注意，不要把文件用BLOB的方式直接写入数据库，这是一个不太聪明的做法）。推荐购买云数据库服务，而且最好和服务器在同一个片区，这样就可以通过云服务提供商的内网直接访问，速度就快多了。

有条件的话，准备一下SSL证书，避免你的数据在网络上裸奔，免费的证书很容易就可以申请的。如果有条件的话，甚至还可以给服务器里保存的文件也加密一下，比如AES之类的，不过本次产品里就没有使用这个了，因为服务器性能比较差，过多的加密会导致性能下降。

最后一个就是带宽问题了，如果服务器是1M的小水管的话，就不建议部署这样的项目了，太慢了……



## 3，代码实现

